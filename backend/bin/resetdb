#!/usr/bin/env bash

set -eo pipefail
cd "$(dirname "${BASH_SOURCE[0]}")/.."

# define env vars
source ../.env
export PGUSER=${POSTGRES_USER}
export PGPASSWORD=${POSTGRES_PASSWORD}
export PGHOST=${POSTGRES_HOST}
export PGPORT=${POSTGRES_PORT}

# terminate all connections to the db
psql -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = '${POSTGRES_DB}' AND pid <> pg_backend_pid()" || :

# drop current database
dropdb --if-exists ${POSTGRES_DB}

# create db
createdb ${POSTGRES_DB}

# run migrations
venv/bin/python src/manage.py migrate

# fetch and load IMDb's data dump
venv/bin/python src/manage.py imdb_dataload
